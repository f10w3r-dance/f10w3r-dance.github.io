---
layout: post
date: 2020-12-21
title: "2020ë…„ 11ì›” PlugX ë¶„ì„ ì´ì•¼ê¸° 2íŽ¸(Stage1 ë¶„ì„)"
author: "f10w3r"
tags: malware apt41 plugx
---

[2020ë…„ 11ì›” PlugX ë¶„ì„ ì´ì•¼ê¸° 1íŽ¸(ìƒ˜í”Œ í™•ë³´) ë³´ëŸ¬ ê°€ê¸°](PlugX-1.md)

ì§€ë‚œ ì‹œê°„ì— ì´ì–´ ìƒ˜í”Œ í™•ë³´ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ì´ì œ ë³¸ê²©ì ì¸ ë¶„ì„ì„ ì‹œìž‘í•´ë³´ì£ !

ì´ì „ê¸€ì—ì„œ í™•ì¸í–ˆì§€ë§Œ, `C4164EFA57204AD32AEC2B0F1A12BB3A` ìƒ˜í”Œì€ `license.rtf` íŒŒì¼ì„ ì½ì–´ ë©”ëª¨ë¦¬ìƒì—ì„œ ì‰˜ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìžˆëŠ” ì•…ì„±ì½”ë“œ ìž…ë‹ˆë‹¤.(ì•„ëž˜ ê·¸ë¦¼ì„ ì°¸ê³ í•´ì£¼ì„¸ìš”.)

![pic1](pic/ida_screen.png?raw=true)


ì¼ë‹¨ APT41ì€ ê¸°ë³¸ì ìœ¼ë¡œ ì‰˜ì½”ë“œë¥¼ ë§¤ìš° ì‚¬ëž‘í•˜ëŠ” ì¡°ì§ì¸ë“¯ í•©ë‹ˆë‹¤.(ê¸€ì“´ì´ í”¼ì…œ) ì´ ê·¸ë£¹ì„ ë¶„ì„í•  ë•Œë©´, í•­ìƒ ë¶„ì„í•˜ê¸°ê°€ ì‹«êµ°ìš” ã…Žã…Ž..

![pic2](pic/fuckingshellcode.jpg?raw=true)


ì œì¼ ë¨¼ì € `C4164EFA57204AD32AEC2B0F1A12BB3A` ì•…ì„±ì½”ë“œëŠ” `license.rtf`ì˜ ë°ì´í„°ë¥¼ ì½ì–´ì™€ `VirtualAlloc` í•¨ìˆ˜ë¥¼ í†µí•´ ì‹¤í–‰ ê°€ëŠ¥í•œ ë©”ëª¨ë¦¬ë¥¼ í• ë‹¹ ë°›ê³  ë°ì´í„°ë¥¼ ì½ì–´ì˜µë‹ˆë‹¤.

![pic3](pic/ìŠ¤í¬ë¦°ìƒ·%202020-12-20%20ì˜¤í›„%2010.39.37.png?raw=true)


ê·¸ë¦¬ê³ ëŠ” ë¬´ìžë¹„í•˜ê²Œë„ ë’¤ë„ ì•ˆëŒì•„ë³´ê³  ë°”ë¡œ ì‰˜ì½”ë“œë¡œ ì í”„ í•´ë²„ë¦½ë‹ˆë‹¤.

![pic4](pic/ìŠ¤í¬ë¦°ìƒ·%202020-12-20%20ì˜¤í›„%2010.42.06.png?raw=true)


ë°©ê¸ˆ ë¶„ì„ìœ¼ë¡œ ìš°ë¦¬ëŠ” ë¬´ë ¤ ë‹¹ì—°í•˜ì§€ë§Œ ì¤‘ìš”í•œ 2ê°€ì§€ ì •ë³´ë¥¼ ì–»ì—ˆìŠµë‹ˆë‹¤! 

1. ì‰˜ì½”ë“œëŠ” ë§¨ ì²˜ìŒë¶€í„° ì‹¤í–‰ëœë‹¤.
2. license.rtf íŒŒì¼ì€ ì•”í˜¸í™” í˜¹ì€ ì¸ì½”ë”© ë˜ì–´ìžˆì§€ ì•Šì•˜ì„ê²ƒì´ë‹¤.

ë”°ë¼ì„œ ìž¬ë¹¨ë¦¬ `license.rtf` íŒŒì¼ì„ ë¶„ì„ í•´ë³´ê² ìŠµë‹ˆë‹¤.

ì œì¼ ë¨¼ì € `license.rtf`ë¥¼ IDAë¥¼ í†µí•´ í™•ì¸í•´ë³´ë©´ ì˜ˆìœ hex-rayê°€ ìš°ë¦¬ë¥¼ ê¸°ë‹¤ë ¤ì£¼ê³  ìžˆì„ê²ë‹ˆë‹¤.

![pic5](pic/ìŠ¤í¬ë¦°ìƒ·%202020-12-20%20ì˜¤í›„%2011.28.15.png)


... í›„...

![pic6](pic/fuckingshellcode.jpg?raw=true)


ë§ˆìŒì„ ì§„ì •ì‹œí‚¤ê³  ì°¨ê·¼ì°¨ê·¼ ë¶„ì„ í•´ë³´ê² ìŠµë‹ˆë‹¤. ì—¬ëŸ¬ë¶„ë„ ì§„ì •í•˜ì„¸ìš”..!

ì œì¼ ë¨¼ì € ëˆˆì— ë“¤ì–´ì˜¤ëŠ”ê±´ ì´ ë¶€ë¶„ìž…ë‹ˆë‹¤.
```asm
push    12CF1h
call    near ptr dword_1283C+4BFh
```

ì „ ì œì¼ ë¨¼ì € ì¸ìžë¡œ ë“¤ì–´ê°€ëŠ” `push    12CF1h` ì´ ë¶€ë¶„ì´ ìˆ˜ìƒí•´ ë³´ì˜€ìŠµë‹ˆë‹¤. 

`f10w3r: ë™ìž‘ ê·¸ë§Œ, ë°‘ìž¥ ê¹”ê¸°ëƒ? ë„ˆëŠ” ì§€ê¸ˆ ì˜¤í”„ì…‹ì„ ìŠ¤íƒì—ë‹¤ ê¹”ì•˜ì–´ ê·¸ë¦¬ê³  ì½”ë“œ ë°‘ì— ì •ìƒì ì¸ retì´ ì—†ëŠ”ê±¸ ë³´ë‹ˆê¹Œ call ì•ˆì—ì„œ í•¨ìˆ˜ í”„ë¡¤ë¡œê·¸ ë”°ìœ„ëŠ” ì—†ëŠ”ê±° ê² ì§€ ê·¸ëŸ¼ ë„ˆëŠ” call í˜¸ì¶œì‹œì— ìŠ¤íƒì— ê¹”ë¦¬ëŠ” ë‹¤ìŒ instructionì˜ ì£¼ì†Œì— ë‹ˆê°€ ë„£ì–´ì¤€ ì˜¤í”„ì…‹ì„ ë”í•´ì„œ ë­”ê°€ ì¡°ìž¡í•œì§“ì„ í• ê²ƒì´ì•¼ ë‚´ê°€ ë¹™ë‹¤ë¦¬ í•«ë°”ì§€ë¡œ ë³´ì´ëƒ ì´ ìƒˆë¼ì•¼?`

![pic7](pic/ë°‘ìž¥ë¹¼ê¸°ëƒ.jpeg)


ì´ì–´ì„œ í˜¸ì¶œë˜ëŠ” `call near ptr dword_1283C+4BFh`ëŠ” ì•„ëž˜ì™€ ê°™ìŠµë‹ˆë‹¤.

![pic8](pic/ìŠ¤í¬ë¦°ìƒ·%202020-12-20%20ì˜¤í›„%2011.37.55.png)

ì—­ì‹œ í•¨ìˆ˜ í”„ë¡¤ë¡œê·¸ëŠ” ì—†êµ°ìš” ë°©ê¸ˆì „ê³¼ ê°™ì€ ë°©ì‹ìœ¼ë¡œ ì¸ìžë¥¼ í•˜ë‚˜ ë” ì„¤ì •í•˜ê³  ë‹¤ìŒ `sub_14211`ì„ í˜¸ì¶œ í•©ë‹ˆë‹¤.

`sub_14211` í•¨ìˆ˜ë¥¼ ë³´ê¸°ì „ `sub_14211` í•¨ìˆ˜ í˜¸ì¶œ ì§í›„ ìž ì‹œ ìž ì‹œ ìŠ¤íƒ ìƒí™©ì„ ë¨¼ì € ê·¸ë ¤ë³´ë©´ ì•„ëž˜ì™€ ê°™ì„ê²ë‹ˆë‹¤.

|ìŠ¤íƒ(ì•„ëž˜ê°€ ë†’ì€ ì£¼ì†Œ)|
|------|
|12D05h(call ë‹¤ìŒ ins)|
|150Ch(pushë¡œ ë„£ì€ ê°’)|
|0Ah(callë‹¤ìŒ ins)|
|12CF1h(pushë¡œ ë„£ì€ ê°’)|


ì´ë ‡ê²Œ ìŠ¤íƒ êµ¬ì¡°ë¥¼ ê¸°ì–µí•´ ë†“ì€ ë’¤ `sub_14211`ë¥¼ í™•ì¸í•´ë³´ë©´ ë‚´ë¶€ì—ì„œ í•¨ìˆ˜ `sub_14217`ë¥¼ í˜¸ì¶œí•˜ê³  ì •ìƒì ìœ¼ë¡œ `return`í•˜ëŠ” ëª¨ìŠµì„ í™•ì¸í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

```
seg000:00014211 sub_14211       proc near               ; CODE XREF: seg000:00012D00â†‘p
seg000:00014211                 call    sub_14217
seg000:00014216                 retn
seg000:00014216 sub_14211       endp ; sp-analysis failed
```

 `sub_14217` í•¨ìˆ˜ ë‚´ë¶€ë¡œ ë“¤ì–´ ê°€ë³´ë©´, ì •ìƒì ìœ¼ë¡œ í•¨ìˆ˜ í”„ë¡¤ë¡œê·¸ë¥¼ ì‹¤í–‰í•˜ëŠ”ê²ƒì„ í™•ì¸í•  ìˆ˜ ìžˆìœ¼ë©°, ì´ëŠ” ë‹¤ì‹œ ë§í•´ ìœ„ì—ì„œ `push`ì™€ `call`ë¡œ ìŠ¤íƒì— ë„£ì€ ê°’ë“¤ì´ `sub_14217`ì˜ ì¸ìžë¡œ ì„¤ì •ëœ ê²ƒì„ ì˜ˆìƒ í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. í•´ë‹¹ í•¨ìˆ˜ì˜ ê²½ìš° ì •ìƒì ì¸ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìžˆê¸° ë–„ë¬¸ì— í•¨ìˆ˜ë¡œ ì¸ì‹ë˜ì–´ IDAì—ì„œ hex-ray ì½”ë“œë¡œ ë³€í™˜ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

 ![pic9](./pic/ìŠ¤í¬ë¦°ìƒ·%202020-12-20%20ì˜¤í›„%2011.46.45.png)


ê·¸ë¦¬ê³ ëŠ” `fs:[0x30]` ì— ì ‘ê·¼í•˜ì—¬ **Process Environment Block**ì„ ê°€ì ¸ì™€ `kernel32.dll`ì— ì¡´ìž¬í•˜ëŠ” `GetProcAddress` í•¨ìˆ˜ì˜ ë§µí•‘ëœ ì£¼ì†Œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.

![pic10](./pic/ìŠ¤í¬ë¦°ìƒ·%202020-12-20%20ì˜¤í›„%2011.51.04.png)


ì´í›„ `GetProcAddress`í•¨ìˆ˜ë¥¼ í†µí•´ ì•…ì„±ì½”ë“œ ë‚´ë¶€ì—ì„œ ì‚¬ìš©í•  í•¨ìˆ˜ì˜ ë§µí•‘ëœ ì£¼ì†Œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. 

ì´ ìžì‹, ìƒê°ë³´ë‹¤ ì°©í•œ ë†ˆì´ì˜€ìŠµë‹ˆë‹¤. ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ë¥¼ í•´ì‹œí™” ì‹œí‚¤ì§€ ì•Šë‹¤ë‹ˆ.. í•˜ë§ˆí„°ë©´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì§œì•¼í•˜ëŠ”ì¤„ ì•Œê³  ê¸´ìž¥í–ˆìŠµë‹ˆë‹¤..

### 16ë°”ì´íŠ¸ ë°ì´í„° ë³µí˜¸í™”

![pic11](./pic/ìŠ¤í¬ë¦°ìƒ·%202020-12-20%20ì˜¤í›„%2011.54.03.png)

ë‹¤ìŒ í–‰ìœ„ë¥¼ ë³´ë‹ˆ... ë§¨ ì²˜ìŒì— ë„£ì–´ì¤€ ì¸ìžë¥¼ í†µí•´ì„œ ë­”ê°€ ê°€ì ¸ì™€ 16byte ë§Œí¼ ë³µí˜¸í™”ë¥¼ í•˜ëŠ”ê±° ê°™ë„¤ìš” ë­”ê°€ ìž¥ë‚œì§ˆì„ í•˜ëŠ”êµ°ìš”! ìž ì‹œ ì°©í•œë†ˆì´ë¼ê³  ìƒê°í•œ ì œê°€ ë°”ë³´ì˜€ìŠµë‹ˆë‹¤.. í•˜ì•„..ðŸ¤¦ðŸ»â€â™‚ï¸

![pic12](./pic/ìŠ¤í¬ë¦°ìƒ·%202020-12-21%20ì˜¤ì „%2012.00.57.png)

### í° ë°ì´í„° ë³µí˜¸í™”

ì¼ë‹¨ ë³µí˜¸í™” ì½”ë“œë¥¼ ì œìž‘í•˜ê¸° ì „ì— ì „ì²´ ê¸°ëŠ¥ë¶€í„° í¬ê²Œ ë‘˜ëŸ¬ ë³´ê³  ì œìž‘í•˜ê² ìŠµë‹ˆë‹¤.

ìœ„ì—ì„œ ë³µí˜¸í™”ëœ 16byteê°’ì„ ì•Œì•„ ë‚´ê¸° ìœ„í•´ ë‹¤ìŒ ë³µí˜¸í™” ì½”ë“œë¥¼ ë³´ë‹ˆ 16byteì§œë¦¬ êµ¬ì¡°ì²´ì¸ê²ƒì„ ì•Œ ìˆ˜ ìžˆì—ˆìŠµë‹ˆë‹¤. 

```c++
  // ë°ì´í„° ë³µí˜¸í™” 2ë²ˆì§¸ (ìœ„ì— ìº¡ì²˜ì½”ë“œ ì•„ëž˜ìžˆëŠ” ì½”ë“œìž…ë‹ˆë‹¤.)
  size = dec_16buf_size + 16;
  dec_buf = VirtualAlloc(0, dec_16buf_size + 16, 4096, 4);
  if ( !dec_buf )
    return (int **)&loc_B;
  v22 = keyinit;
  v23 = keyinit;
  key3 = keyinit;
  key4 = keyinit;
  if ( size > 0 )
  {
    v24 = (_BYTE *)dec_buf;
    key2_tmp = (int)_0Ah - dec_buf;
    do
    {
      v22 = v22 + (v22 >> 3) - 0x11111111;
      v23 = v23 + (v23 >> 5) - 0x22222222;
      key3 += 0x33333333 - (key3 << 7);
      key4 += 0x44444444 - (key4 << 9);
      *v24 = v24[key2_tmp] ^ (key4 + key3 + v23 + v22);
      ++v24;
      --size;
    }
    while ( size );
  }
```

ì¦‰ 16ë°”ì´íŠ¸ ë§Œí¼ ë³µí˜¸í™”ëœ ë°ì´í„°ëŠ” ì•„ëž˜ì™€ ê°™ì€ êµ¬ì¡°ì²´ë¥¼ ê°€ì§‘ë‹ˆë‹¤.

```c++
  char keyinit[4]; // [esp+8h] [ebp-100h] BYREF
  int unkown_compare_pattern; // [esp+Ch] [ebp-FCh]
  int unkown2_compare_pattern; // [esp+10h] [ebp-F8h]
  int dec_16buf_size; // [esp+14h] [ebp-F4h]
```

ì´í›„ ë³µí˜¸í™”ëœ í° ë°ì´í„°ë¥¼ `RtlDecompressBuffer` ì••ì¶• í•´ì œë¥¼ í•´ì¤ë‹ˆë‹¤. ì•„ëž˜ ì½”ë“œ(ì œëŒ€ë¡œ ë³µí˜¸í™” ë˜ì—ˆëŠ”ì§€ PEêµ¬ì¡° í™•ì¸)ë¥¼ ë³¼ ë•Œ ë³µí˜¸í™”ëœ í° ë°ì´í„°ëŠ” ì¶”ê°€ ì•…ì„±ì½”ë“œì¸ê²ƒ ê°™ìŠµë‹ˆë‹¤. 

![pic13](./pic/ìŠ¤í¬ë¦°ìƒ·%202020-12-21%20ì˜¤ì „%2012.31.58.png)

ë³µí˜¸í™” í–‰ìœ„ ì´í›„ì—ëŠ” ë°‘ìž¥ ê¹”ê¸°ë¡œ ë„£ì€ ì¸ìžì™€ í•¨ê»˜ ë©”ëª¨ë¦¬ì— ë¡œë“œëœ í›„ ì‹¤í–‰ ë©ë‹ˆë‹¤.

### ë³µí˜¸í™” ì½”ë“œ

ë³µí˜¸í™” ì½”ë“œ ì œìž‘í•˜ë©´ì„œ ë°ì´í„° ë‚ ë ¤ë¨¹ìœ¼ë©´ ë³µì›ì´ ì–´ë µìŠµë‹ˆë‹¤.. 

IDA 7.5 ë²„ì „ì—ì„œëŠ” `Ctrl-Z` ê¸°ëŠ¥ì´ ê°€ëŠ¥í•œë°, ì§€ê¸ˆ ê¹”ë ¤ìžˆëŠ” ë²„ì „ì´ 7.2 ë²„ì „ì´ë¼ ê·€ì°®ì€ ê´€ê³„ë¡œ `C4164EFA57204AD32AEC2B0F1A12BB3A` í•´ì‹œì—ì„œ `Segment`ë¥¼ ìƒì„±í•´ì„œ ìž‘ì—… í–ˆìŠµë‹ˆë‹¤.

```python
from idaapi import *
from idautils import *
from idc import *
from struct import unpack, pack
import lznt1

def read_shellcode(base):
    with open("license.rtf", "rb") as p:
        data = p.read()
    size = len(data)
    add_segm(0, base, base + size, "CODE", "CODE")
    patch_bytes(base, data)

def decrypt(base, size):
    tmpkey = get_dword(base)
    key1 = key2 = key3 = key4 = tmpkey
    ea = base
    data = bytearray(get_bytes(ea, size))
    for i in range(size):
        key1 = key1 + (key1 >> 3) - 0x11111111
        key1 &= 0xffffffff
        key2 = key2 + (key2 >> 5) - 0x22222222
        key2 &= 0xffffffff
        key3 += 0x33333333 - (key3 << 7)
        key3 &= 0xffffffff
        key4 += 0x44444444 - (key4 << 9)
        key4 &= 0xffffffff
        data[i] = (data[i] ^ (key1 + key2 + key3 + key4))&0xff
    return bytes(data)
    
if __name__ == "__main__":
    base = 0x41410000
    read_shellcode(base)
    struct = decrypt(base+0xa, 16)
    size = unpack("<L", struct[12:16])[0] + 16
    
    data = bytes(decrypt(base+0xa, size)[16:])
    decompressed = lznt1.decompress(data)
    
    stage2_base = 0x42420000
    add_segm(0, stage2_base, stage2_base + len(decompressed), "CODE", "CODE")
    patch_bytes(stage2_base, decompressed)
    with open("dump.bin", "wb") as p:
        p.write(decompressed)
    print("base addr: 0x%x, size: %d, newbase: 0x%x"%(base, size,stage2_base))
```